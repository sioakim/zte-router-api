<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZTE Fiber Dashboard</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --success: #00d26a;
            --warning: #ffc107;
            --fiber: #00ff88;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .timestamp {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .live-indicator.offline {
            background: var(--text-secondary);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-top: 3px solid var(--fiber);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--bg-card);
        }

        .device-name {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .device-ip {
            color: var(--fiber);
            font-family: monospace;
        }

        .device-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .section-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 15px;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .metric {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--fiber);
        }

        .metric.warning {
            border-left-color: var(--warning);
        }

        .metric.critical {
            border-left-color: var(--accent);
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
            font-family: monospace;
        }

        .metric-value.good { color: var(--success); }
        .metric-value.warning { color: var(--warning); }
        .metric-value.critical { color: var(--accent); }

        .port-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .port {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .port.active {
            border-left: 3px solid var(--success);
        }

        .port.inactive {
            border-left: 3px solid var(--text-secondary);
            opacity: 0.7;
        }

        .port-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .port-status.active {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .port-status.inactive {
            background: var(--text-secondary);
        }

        .port-name {
            flex: 1;
            font-weight: 500;
        }

        .port-speed {
            font-family: monospace;
            font-size: 0.85rem;
            padding: 3px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-left: 10px;
        }

        .port-speed.fast { color: var(--success); }
        .port-speed.medium { color: var(--warning); }

        .port-traffic {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            margin-left: 10px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: var(--accent);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ZTE Fiber Dashboard</h1>
        <div class="timestamp">
            <span class="live-indicator" id="live-indicator"></span>
            <span id="timestamp-text">Loading...</span>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="loading">Connecting to ZTE API...</div>
    </div>

    <script>
        // Use proxied API endpoints (served by server.py)
        const API_BASE = '/api';

        async function fetchData() {
            const dashboard = document.getElementById('dashboard');
            const timestampText = document.getElementById('timestamp-text');
            const liveIndicator = document.getElementById('live-indicator');

            try {
                // Fetch all data in parallel via proxy
                const [ponRes, lanRes, deviceRes, systemRes] = await Promise.all([
                    fetch(`${API_BASE}/pon`),
                    fetch(`${API_BASE}/lan`),
                    fetch(`${API_BASE}/device`),
                    fetch(`${API_BASE}/system/stats`)
                ]);

                if (!ponRes.ok || !lanRes.ok || !deviceRes.ok || !systemRes.ok) {
                    throw new Error('API request failed');
                }

                const [pon, lan, device, system] = await Promise.all([
                    ponRes.json(),
                    lanRes.json(),
                    deviceRes.json(),
                    systemRes.json()
                ]);

                // Update status
                liveIndicator.classList.remove('offline');
                timestampText.textContent = `Live - ${new Date().toLocaleString()}`;

                // Render dashboard
                renderDashboard({ pon, lan, device, system });

            } catch (error) {
                console.error('Error fetching data:', error);
                liveIndicator.classList.add('offline');
                timestampText.textContent = 'Disconnected';
                dashboard.innerHTML = `<div class="error">Failed to connect to ZTE API<br><small>${error.message}</small></div>`;
            }
        }

        function getPowerClass(rxPower) {
            if (rxPower === null || rxPower === undefined) return 'good';
            if (rxPower < -27) return 'critical';
            if (rxPower < -25) return 'warning';
            return 'good';
        }

        function getTempClass(temp) {
            if (temp === null || temp === undefined) return 'good';
            if (temp > 80) return 'critical';
            if (temp > 70) return 'warning';
            return 'good';
        }

        function formatSpeed(mbps) {
            if (!mbps) return '';
            if (mbps >= 10000) return '10Gbps';
            if (mbps >= 1000) return `${mbps / 1000}Gbps`;
            return `${mbps}Mbps`;
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(1)} ${units[i]}`;
        }

        function formatUptime(seconds) {
            if (!seconds) return 'Unknown';
            const weeks = Math.floor(seconds / 604800);
            const days = Math.floor((seconds % 604800) / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);

            let result = '';
            if (weeks > 0) result += weeks + 'w ';
            if (days > 0) result += days + 'd ';
            if (hours > 0) result += hours + 'h ';
            result += mins + 'm';
            return result;
        }

        function renderDashboard(data) {
            const { pon, lan, device, system } = data;
            const rxClass = getPowerClass(pon.rx_power_dbm);
            const tempClass = getTempClass(pon.temperature_c);
            const activePorts = lan.filter(p => p.link === 'Up').length;

            document.getElementById('dashboard').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="device-name">${device.model || 'ZTE F8648P'}</div>
                            <div class="device-ip">${device.serial_number || ''}</div>
                        </div>
                    </div>
                    <div class="device-meta">
                        <span>Firmware: ${device.software_version || 'N/A'}</span>
                        <span>Uptime: ${formatUptime(system.uptime_seconds)}</span>
                        <span>CPU: ${system.cpu_usage || 0}%</span>
                        <span>RAM: ${system.memory_usage || 0}%</span>
                    </div>

                    <div class="section-label">PON Optical Module</div>
                    <div class="metrics-grid">
                        <div class="metric ${rxClass}">
                            <div class="metric-label">RX Power</div>
                            <div class="metric-value ${rxClass}">${pon.rx_power_dbm?.toFixed(2) || 'N/A'} dBm</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">TX Power</div>
                            <div class="metric-value good">${pon.tx_power_dbm?.toFixed(2) || 'N/A'} dBm</div>
                        </div>
                        <div class="metric ${tempClass}">
                            <div class="metric-label">Temperature</div>
                            <div class="metric-value ${tempClass}">${pon.temperature_c?.toFixed(1) || 'N/A'} Â°C</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Voltage</div>
                            <div class="metric-value good">${pon.voltage_mv || 'N/A'} mV</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Bias Current</div>
                            <div class="metric-value good">${pon.current_ma?.toFixed(2) || 'N/A'} mA</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">ONU State</div>
                            <div class="metric-value good">${pon.onu_state?.replace('Operation State ', '') || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="section-label">LAN Ports (${activePorts}/${lan.length} active)</div>
                    <div class="port-list">
                        ${lan.map(port => {
                            const isActive = port.link === 'Up';
                            const speedStr = formatSpeed(port.speed);
                            const speedClass = port.speed >= 10000 ? 'fast' : (port.speed >= 1000 ? 'medium' : '');
                            return `
                                <div class="port ${isActive ? 'active' : 'inactive'}">
                                    <div class="port-status ${isActive ? 'active' : 'inactive'}"></div>
                                    <span class="port-name">${port.name}</span>
                                    ${speedStr ? `<span class="port-speed ${speedClass}">${speedStr}</span>` : ''}
                                    ${isActive && port.bytes_rx ? `
                                        <div class="port-traffic">
                                            RX: ${formatBytes(port.bytes_rx)}<br>
                                            TX: ${formatBytes(port.bytes_tx)}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Initial load
        fetchData();

        // Refresh every 30 seconds
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
